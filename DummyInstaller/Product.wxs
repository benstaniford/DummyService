<?xml version="1.0" encoding="UTF-8"?>

<!-- The name of the product -->
<?define Name = "DummyService" ?>
<!-- The description of the service -->
<?define ServiceDesc = "The DummyService service" ?>
<!-- The manufacturer, for setup package publisher and folder info -->
<?define Manufacturer = "BeyondTrust Corporation" ?>
<!-- The version number of this setup package-->
<?define Version = "1.0.0" ?>
<!-- UpgradeCode must be unique and not changed once the first version of the program is installed. -->
<?define UpgradeCode = "{be5d451f-4a84-4114-8e13-8f54bfd54739}" ?>
<!-- Service GUID must be unique and not changed once the first version of the program is installed. -->
<?define ServiceGuid = "{3962817c-dd58-4639-a488-b08de58914e8}" ?>

<!-- Set config/platform specific variables -->
<?if $(var.Platform) = x64 ?>
  <?define PlatformProgramFilesFolder = "ProgramFiles64Folder" ?>
  <?if $(var.Configuration) = Release ?>
    <?define VcRuntimeMergeModule = "Microsoft_VC140_CRT_x64.msm" ?>
  <?else ?>
    <?define VcRuntimeMergeModule = "Microsoft_VC140_DebugCRT_x64.msm" ?>
  <?endif ?>
<?else ?>
  <?define PlatformProgramFilesFolder = "ProgramFilesFolder" ?>
  <?if $(var.Configuration) = Release ?>
    <?define VcRuntimeMergeModule = "Microsoft_VC140_CRT_x86.msm" ?>
  <?else ?>
    <?define VcRuntimeMergeModule = "Microsoft_VC140_DebugCRT_x86.msm" ?>
  <?endif ?>
<?endif ?>

<Wix xmlns="http://schemas.microsoft.com/wix/2006/wi">
	<Product Id="*" Name="$(var.Name)" Language="1033" Version="$(var.Version)" Manufacturer="$(var.Manufacturer)" UpgradeCode="$(var.UpgradeCode)">
		<Package InstallerVersion="200" Compressed="yes" InstallScope="perMachine" />

    <!-- Create a folder inside Talk Sharp called Test Service -->
    <Media Id="1" Cabinet="$(var.Name).cab" EmbedCab="yes" />
		<MajorUpgrade DowngradeErrorMessage="A newer version of [ProductName] is already installed." />

		<Feature Id="ProductFeature" Title="DummyInstaller" Level="1">
			<ComponentGroupRef Id="ProductComponents" />
		</Feature>

    <Feature Id="VCRedist" Title="Visual C++ 2022 Runtime" AllowAdvertise="no" Display="hidden" Level="1">
      <MergeRef Id="VCRedist"/>
    </Feature>
  </Product>

	<Fragment>
		<Directory Id="TARGETDIR" Name="SourceDir">
      <!-- Include the correct VC runtime -->
      <Merge Id="VCRedist" SourceFile="MergeModules\$(var.VcRuntimeMergeModule)" DiskId="1" Language="0"/>

      <Directory Id="$(var.PlatformProgramFilesFolder)">
				<Directory Id="INSTALLFOLDER" Name="DummyInstaller" />
			</Directory>
		</Directory>
	</Fragment>

	<Fragment>
		<ComponentGroup Id="ProductComponents" Directory="INSTALLFOLDER">
      <Component Id="$(var.DummyService.TargetFileName)" Guid="$(var.ServiceGuid)">
        <File Id="$(var.DummyService.TargetFileName)" Source="$(var.DummyService.TargetPath)" KeyPath="yes" />

				<!-- Install the service -->
        <ServiceInstall Id="ServiceInstaller"
        Type="ownProcess"
        Name="$(var.Name)"
        DisplayName="$(var.Name)"
        Description="$(var.ServiceDesc)"
        Start="auto"
        ErrorControl="normal" />

        <!-- Tell WiX to start the Service on install -->
        <ServiceControl Id="StartService" Start="install" Stop="both" Remove="uninstall" Name="$(var.Name)" Wait="yes" />
      </Component>
    </ComponentGroup>
	</Fragment>
</Wix>
